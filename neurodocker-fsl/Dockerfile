# Generated by Neurodocker and Reproenv.

FROM unlhcc/xfce_el7_ood:4.12

ENV FSLDIR="/opt/fsl-6.0.5.1" \
    PATH="/opt/fsl-6.0.5.1/bin:$PATH" \
    FSLOUTPUTTYPE="NIFTI_GZ" \
    FSLMULTIFILEQUIT="TRUE" \
    FSLTCLSH="/opt/fsl-6.0.5.1/bin/fsltclsh" \
    FSLWISH="/opt/fsl-6.0.5.1/bin/fslwish" \
    FSLLOCKDIR="" \
    FSLMACHINELIST="" \
    FSLREMOTECALL="" \
    FSLGECUDAQ="cuda.q"
RUN yum install -y -q \
           bc \
           curl \
           file \
           libGL \
           libGLU \
           libICE \
           libSM \
           libX11 \
           libXcursor \
           libXext \
           libXft \
           libXinerama \
           libXrandr \
           libXt \
           libgomp \
           libjpeg \
           libmng \
           libpng12 \
           nano \
           openblas-serial \
           sudo \
           wget \
    && yum clean all \
    && rm -rf /var/cache/yum/* \
    && echo "Downloading FSL ..." \
    && mkdir -p /opt/fsl-6.0.5.1 \
    && wget -q -O - "https://uofnelincoln.sharepoint.com/:u:/s/UNL-HollandComputingCenter/EUbjaqWTgQtNrKR6C5SjQNABm7kYMHnf_oNJ30AXr3sLsQ?e=BaDLOn&download=1" \
    | tar -xz -C /opt/fsl-6.0.5.1 --strip-components 1

ADD fsl_mamba.patch /opt/fsl-6.0.5.1/
RUN cd /opt/fsl-6.0.5.1/ && \
    patch -p0 -i fsl_mamba.patch -s && \
    rm fsl_mamba.patch

RUN echo "Installing FSL conda environment ..." \
    && bash /opt/fsl-6.0.5.1/etc/fslconf/fslpython_install.sh -f /opt/fsl-6.0.5.1

# Install CUDA 10.2 & symlink eddy_cuda to 10.2 version
# https://www.server-world.info/en/note?os=CentOS_7&p=cuda&f=4
RUN yum -y -q --enablerepo=extras install epel-release && \
    yum -y -q install yum-utils && \
    yum-config-manager --add-repo http://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-rhel7.repo && \
    yum --enablerepo=epel -y -q install cuda-cudart-9-1 cuda-cudart-10-2 libcublas-10-2 cuda-nvtx-10-2 cuda-curand-9-1 cuda-cublas-9-1 libpng12 && \
    yum clean all && \
    ln -s /opt/fsl-6.0.5.1/bin/eddy_cuda10.2 /opt/fsl-6.0.5.1/bin/eddy_cuda

ADD xtract.patch /opt/fsl-6.0.5.1/
# Add patch for xtract 6.0.5 based on https://www.jiscmail.ac.uk/cgi-bin/wa-jisc.exe?A2=ind2107&L=FSL&D=0&P=196878
RUN cd /opt/fsl-6.0.5.1/ && \
    patch -p0 -i xtract.patch -s && \
    rm xtract.patch

# Save specification to JSON.
RUN printf '{ \
  "pkg_manager": "yum", \
  "existing_users": [ \
    "root" \
  ], \
  "instructions": [ \
    { \
      "name": "from_", \
      "kwds": { \
        "base_image": "unlhcc/xfce_el7_ood:4.12" \
      } \
    }, \
    { \
      "name": "env", \
      "kwds": { \
        "FSLDIR": "/opt/fsl-6.0.5.1", \
        "PATH": "/opt/fsl-6.0.5.1/bin:$PATH", \
        "FSLOUTPUTTYPE": "NIFTI_GZ", \
        "FSLMULTIFILEQUIT": "TRUE", \
        "FSLTCLSH": "/opt/fsl-6.0.5.1/bin/fsltclsh", \
        "FSLWISH": "/opt/fsl-6.0.5.1/bin/fslwish", \
        "FSLLOCKDIR": "", \
        "FSLMACHINELIST": "", \
        "FSLREMOTECALL": "", \
        "FSLGECUDAQ": "cuda.q" \
      } \
    }, \
    { \
      "name": "run", \
      "kwds": { \
        "command": "yum install -y -q \\\\\\n    bc \\\\\\n    curl \\\\\\n    file \\\\\\n    libGL \\\\\\n    libGLU \\\\\\n    libICE \\\\\\n    libSM \\\\\\n    libX11 \\\\\\n    libXcursor \\\\\\n    libXext \\\\\\n    libXft \\\\\\n    libXinerama \\\\\\n    libXrandr \\\\\\n    libXt \\\\\\n    libgomp \\\\\\n    libjpeg \\\\\\n    libmng \\\\\\n    libpng12 \\\\\\n    nano \\\\\\n    openblas-serial \\\\\\n    sudo \\\\\\n    wget\\nyum clean all\\nrm -rf /var/cache/yum/*\\necho \\"Downloading FSL ...\\"\\nmkdir -p /opt/fsl-6.0.5.1\\ncurl -fL https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-6.0.5.1-centos7_64.tar.gz \\\\\\n| tar -xz -C /opt/fsl-6.0.5.1 --strip-components 1 \\necho \\"Installing FSL conda environment ...\\"\\nbash /opt/fsl-6.0.5.1/etc/fslconf/fslpython_install.sh -f /opt/fsl-6.0.5.1" \
      } \
    } \
  ] \
}' > /.reproenv.json
# End saving to specification to JSON.
